<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Finder</title>
    <link rel="stylesheet" href="./style.css">

</head>
<body class ="body" onload="searchAlbum()">

    <!--ai CHAT BOT -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai"
        async function sendMessageToGemini(prompt) {
            const genAI = new GoogleGenerativeAI('AIzaSyBK8WyUSFX29GwIiRwyZXwWgeONwp16uhw'); // I know I shouldn't have the API key out, no one will use this website!!
            const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
            const result = await model.generateContent(prompt);
            document.getElementById('AlbumInfoTab').innerHTML += `<p>${result.response.text()}</p>`
            console.log(result.response.text());
        }

        // Example usage
        sendMessageToGemini(`You provide information about albums on an album information website. You need to Write a short but informational paragraph, roughly 3 sentences about ${localStorage.getItem('ExactAlbumName')} by ${localStorage.getItem('ExactArtistName')}. Give strictly relevant information about ${localStorage.getItem('ExactAlbumName')} only. You can talk about the reception of the album and it's relevance within the artists discography.`);
    </script>

    <!--Script for Track List--> 

    <script>
                async function searchAlbum() {
                    var artistSelected = localStorage.getItem('artistSelected');
                    var albumSelected = localStorage.getItem('albumSelected');
                    const albumName = albumSelected;
                    const artistName = artistSelected;
                    const url = `https://musicbrainz.org/ws/2/release/?query=release:${albumName}%20AND%20artist:${artistName}&limit=1&fmt=json`;
                    
                    try {
                        const response = await fetch(url);
                        const data = await response.json()
                        const trackList = document.getElementById('trackList');
                        trackList.innerHTML = '<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>';
                        if (data.releases && data.releases.length > 0) {
                            const releaseId = data.releases[0].id;
                            const releaseUrl = `https://musicbrainz.org/ws/2/release/${releaseId}?inc=recordings&fmt=json`;
                            const releaseResponse = await fetch(releaseUrl);
                            const releaseData = await releaseResponse.json();
                            
                            console.log(releaseData);  // Log data to see what is inside
                            
                            if (releaseData.title) {
                                trackList.innerHTML = `<h2>${releaseData.title}</h2>`;
                                if (releaseData.media && releaseData.media[0].tracks) {
                                    releaseData.media[0].tracks.forEach(track => {
                                        trackList.innerHTML += `<p>${track.position}. ${track.title}</p>`;
                                    });
                                } else {
                                    trackList.innerHTML += '<p>No tracks found.</p>';
                                }
                            } else {
                                trackList.innerHTML = '<p>No valid album data found.</p>';
                            }
                        } else {
                            trackList.innerHTML = '<p>No results found.</p>';
                        }
                    } catch (error) {
                        console.error('Error fetching data:', error);
                        document.getElementById('trackList').innerHTML = '<p>An error occurred while fetching the data. Please try again.</p>';
                    }
                }
    </script>
    
    <!--Script for Image-->

    <script>
        var queryImage = `https://coverartarchive.org/release/${localStorage.getItem('ArtistID')}`;
        console.log(queryImage)
        fetch(queryImage)
            .then(responseImage => responseImage.json())
            .then(imageData => {
                var imageReference = imageData.images[0].thumbnails.large;
                document.getElementById("imageSection").innerHTML += `<img src="${imageReference}" alt="Album cover" style="height: 450px; width: 475px">`; 
                                      
        })

    </script>

    <!--Script for album information-->

    <script id="albumInformationScript">
        var artistSelected = localStorage.getItem('artistSelected');
        var albumSelected = localStorage.getItem('albumSelected');
        var queryArtist = `https://musicbrainz.org/ws/2/release/?query=release:${albumSelected}%20AND%20artist:${artistSelected}&limit=1&fmt=json`;

        fetch(queryArtist)
            .then(responseArtistInfo => responseArtistInfo.json())
            .then(artistInfoData => {
                    const release = artistInfoData.releases[0];
                        var albumName = release.title;
                        localStorage.setItem('ExactAlbumName', albumName)
                        document.getElementById('AlbumNameTab').innerHTML += `<p>Album Name : ${albumName}</p>`
                        var albumArtistName = release['artist-credit'][0].name;
                        localStorage.setItem('ExactArtistName', albumArtistName)
                        document.getElementById('ArtistNameTab').innerHTML += `<p>Artist Name: ${albumArtistName}</p>`;   
                 
            })

    </script>

    <div class="container">
        <h1>Music Finder</h1>

        <div class="details">
            <div class="left">
                <div id="trackList"></div>
            </div>


            <div class ="rightCollection">
                <div class="right" id="imageSection" style="padding: 10px;">
                    <div class="spinner center">
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                        <div class="spinner-blade"></div>
                    </div>
                </div>
                
                <div class="top">
                    <h2>Album Info</h2>
                    <p id="ArtistNameTab"></p>
                    <p id="AlbumNameTab"></p>
                    <p id="AlbumInfoTab"></p>
                 </div>

                 
            </div>

            
        </div>

        <div class="extra-info">
            <p>Here would go a comment box, but I'm working on that </p>
        </div>

        <div class="footer"></div>
    </div>

</body></html>